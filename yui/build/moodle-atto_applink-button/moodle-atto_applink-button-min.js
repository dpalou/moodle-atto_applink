YUI.add("moodle-atto_applink-button",function(e,t){var n="atto_applink",r={ADDUSERNAME:"atto_applink_addusername",NEWWINDOW:"atto_applink_openinnewwindow",OPENINAPP:"atto_applink_openinapp",URLINPUT:"atto_applink_urlentry",URLSCHEME:"atto_applink_urlscheme",USERNAME:"atto_applink_username"},i={ADDUSERNAME:"."+r.ADDUSERNAME,OPENINAPP:"."+r.OPENINAPP,URLINPUT:"."+r.URLINPUT,URLSCHEME:"."+r.URLSCHEME,USERNAME:"."+r.USERNAME},s='<form class="atto_form">{{#if showFilepicker}}<label for="{{elementid}}_atto_link_urlentry">{{get_string "enterurl" component}}</label><div class="input-group input-append w-100 mb-1"><input class="form-control url {{CSS.URLINPUT}}" type="url" id="{{elementid}}_atto_link_urlentry"/><span class="input-group-append"><button class="btn btn-secondary openlinkbrowser" type="button">{{get_string "browserepositories" component}}</button></span></div>{{else}}<div class="mb-1"><label for="{{elementid}}_atto_applink_urlentry">{{get_string "enterurl" component}}</label><input class="form-control fullwidth url {{CSS.URLINPUT}}" type="url" id="{{elementid}}_atto_applink_urlentry" size="32"/></div>{{/if}}<div class="form-check"><input type="checkbox" class="form-check-input newwindow" id="{{elementid}}_{{CSS.NEWWINDOW}}"/><label class="form-check-label" for="{{elementid}}_{{CSS.NEWWINDOW}}">{{get_string "openinnewwindow" component}}</label></div><hr></hr><div class="form-check"><input type="checkbox" class="form-check-input {{CSS.OPENINAPP}}" id="{{elementid}}_{{CSS.OPENINAPP}}"/><label class="form-check-label" for="{{elementid}}_{{CSS.OPENINAPP}}">{{get_string "openinapp" component}}</label></div><div class="mb-1"><label for="{{elementid}}_atto_applink_urlscheme">{{get_string "urlscheme" component}} {{{helpStrings.urlscheme}}}</label><input class="form-control fullwidth {{CSS.URLSCHEME}}" type="text" id="{{elementid}}_atto_applink_urlscheme" size="32"/></div><p></p><div class="form-check"><input type="checkbox" class="form-check-input {{CSS.ADDUSERNAME}}" id="{{elementid}}_{{CSS.ADDUSERNAME}}"/><label class="form-check-label" for="{{elementid}}_{{CSS.ADDUSERNAME}}">{{get_string "addusername" component}}</label></div><div class="mb-1"><label for="{{elementid}}_atto_applink_username">{{get_string "username" component}}{{{helpStrings.username}}}</label><input class="form-control fullwidth {{CSS.USERNAME}}" type="text" id="{{elementid}}_atto_applink_username" size="32"/></div><div class="mdl-align"><br/><button type="submit" class="btn btn-secondary submit">{{get_string "createlink" component}}</button></div></form>';e.namespace("M.atto_applink").Button=e.Base.create("button",e.M.editor_atto.EditorPlugin,[],{_currentSelection:null,_content:null,initializer:function(){this.addButton({icon:"e/insert_edit_link",keys:"75",callback:this._displayDialogue,tags:"a",tagMatchRequiresAll:!1}),this.addButton({buttonName:"unlink",callback:this._unlink,icon:"e/remove_link",title:"unlink",tags:"a",tagMatchRequiresAll:!1})},_displayDialogue:function(){this._currentSelection=this.get("host").getSelection();if(this._currentSelection===!1)return;var e=this.getDialogue({headerContent:M.util.get_string("createlink",n),width:"auto",focusAfterHide:!0,focusOnShowSelector:i.URLINPUT});e.set("bodyContent",this._getDialogueContent()),this._resolveAnchors(),this._updateEnabled(),e.show()},_resolveAnchors:function(){var t=this.get("host").getSelectionParentNode(),n,r,s,o,u,a,f,l;if(!t)return;n=this._findSelectedAnchors(e.one(t)),n.length>0&&(r=n[0],this._currentSelection=this.get("host").getSelectionFromNode(r),s=r.getAttribute("href"),o=r.getAttribute("target"),u=r.hasAttribute("data-app-link"),a=r.getAttribute("data-app-link"),f=r.hasAttribute("data-username"),l=r.getAttribute("data-username"),s!==""&&this._content.one(".url").setAttribute("value",s),o==="_blank"?this._content.one(".newwindow").setAttribute("checked","checked"):this._content.one(".newwindow").removeAttribute("checked"),u?(this._content.one(i.OPENINAPP).setAttribute("checked","checked"),this._content.one(i.URLSCHEME).set("value",a)):this._content.one(i.OPENINAPP).removeAttribute("checked"),!u||!f?(this._content.one(i.ADDUSERNAME).removeAttribute("checked"),f&&this._content.one(i.USERNAME).set("value",l)):(this._content.one(i.ADDUSERNAME).setAttribute("checked","checked"),this._content.one(i.USERNAME).set("value",l)))},_filepickerCallback:function(e){this.getDialogue().set("focusAfterHide",null).hide(),e.url!==""&&(this._setLinkOnSelection(e.url),this.markUpdated())},_setLink:function(e){var t,n;e.preventDefault(),this.getDialogue({focusAfterHide:null}).hide(),t=this._content.one(".url"),n=t.get("value");if(n!==""){n=n.trim();var r=new RegExp(/^[a-zA-Z]*\.*\/|^#|^[a-zA-Z]*:/);r.test(n)||(n="http://"+n),this._setLinkOnSelection(n),this.markUpdated()}},_setLinkOnSelection:function(t){var n=this.get("host"),r,s,o,u;this.editor.focus(),n.setSelection(this._currentSelection),this._currentSelection[0].collapsed?(r=e.Node.create("<a>"+t+"</a>"),r.setAttribute("href",t),s=n.insertContentAtFocusPoint(r.get("outerHTML")),n.setSelection(n.getSelectionFromNode(s))):(document.execCommand("unlink",!1,null),document.execCommand("createLink",!1,t),s=n.getSelectionParentNode());if(!s)return;return u=this._findSelectedAnchors(e.one(s)),e.Array.each(u,function(e){o=this._content.one(".newwindow"),o.get("checked")?e.setAttribute("target","_blank"):e.removeAttribute("target"),o=this._content.one(i.OPENINAPP),o.get("checked")?(o=this._content.one(i.URLSCHEME).get("value").trim(),o?e.setAttribute("data-app-link",o):e.setAttribute("data-app-link",""),o=this._content.one(i.ADDUSERNAME),o.get("checked")?(o=this._content.one(i.USERNAME).get("value").trim(),o?e.setAttribute("data-username",o):e.setAttribute("data-username","")):e.removeAttribute("data-username")):(e.removeAttribute("data-app-link"),e.removeAttribute("data-username"))},this),s},_findSelectedAnchors:function(e){var t=e.get("tagName"),n,r;return t&&t.toLowerCase()==="a"?[e]:(r=[],e.all("a").each(function(e){!n&&
this.get("host").selectionContainsNode(e)&&r.push(e)},this),r.length>0?r:(n=e.ancestor("a"),n?[n]:[]))},_getDialogueContent:function(){var t=this.get("host").canShowFilepicker("link"),o=e.Handlebars.compile(s);return this._content=e.Node.create(o({showFilepicker:t,component:n,CSS:r,helpStrings:this.get("help")})),this._content.one(".submit").on("click",this._setLink,this),this._content.one(i.OPENINAPP).on("change",this._updateEnabled,this),this._content.one(i.ADDUSERNAME).on("change",this._updateEnabled,this),t&&this._content.one(".openlinkbrowser").on("click",function(e){e.preventDefault(),this.get("host").showFilepicker("link",this._filepickerCallback,this)},this),this._content},_unlink:function(){var e=this.get("host"),t=e.getSelection();if(t&&t.length)if(t[0].startOffset===t[0].endOffset){var n=e.getSelectedNodes();n&&(n.each(function(t){var n=t.ancestor("a",!0);n&&(e.setSelection(e.getSelectionFromNode(n)),document.execCommand("unlink",!1,null))},this),this.markUpdated())}else document.execCommand("unlink",!1,null),this.markUpdated()},_updateEnabled:function(){var e=this._content,t=e.one(i.OPENINAPP).get("checked"),n=e.one(i.ADDUSERNAME).get("checked");e.one(i.URLSCHEME).set("disabled",!t),e.one(i.ADDUSERNAME).set("disabled",!t),e.one(i.USERNAME).set("disabled",!t||!n),this.getDialogue().centerDialogue()}},{ATTRS:{help:{}}})},"@VERSION@",{requires:["moodle-editor_atto-plugin"]});
